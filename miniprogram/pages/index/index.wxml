<!--pages/index/index.wxml-->
<view class="container">
  <view class="header">
    <text class="title">🎭 AI 情绪表情生成器</text>
    <text class="subtitle">上传图片，AI 自动生成不同情绪的表情图片</text>
  </view>

  <!-- 上传区域 -->
  <view class="upload-area" bindtap="chooseImage">
    <image wx:if="{{previewImage}}" src="{{previewImage}}" class="preview-image" mode="aspectFit"></image>
    <view wx:else class="upload-placeholder">
      <text class="upload-icon">📸</text>
      <text class="upload-text">点击选择图片</text>
      <text class="upload-hint">支持 JPG、PNG 格式，最大 10MB</text>
    </view>
  </view>

  <!-- 文件信息 -->
  <view wx:if="{{fileInfo}}" class="file-info">{{fileInfo}}</view>

  <!-- 情绪选择 -->
  <view class="emotion-selector">
    <text class="emotion-label">选择情绪：</text>
    <view class="emotion-buttons">
      <view 
        wx:for="{{emotions}}" 
        wx:key="englishName"
        class="emotion-btn {{selectedEmotion === item.englishName ? 'active' : ''}}"
        bindtap="selectEmotion"
        data-emotion="{{item.englishName}}"
      >
        <text class="emotion-icon">{{item.icon}}</text>
        <text class="emotion-text">{{item.chineseName}}</text>
      </view>
    </view>
  </view>

  <!-- 自定义文字输入 -->
  <view class="text-input-area">
    <text class="text-input-label">自定义文字（可选）：</text>
    <input 
      class="text-input" 
      type="text" 
      placeholder="输入你想添加到图片上的文字，留空则不添加文字"
      value="{{customText}}"
      bindinput="onTextInput"
      maxlength="50"
    />
    <text class="text-input-hint">文字将显示在图片中间，支持自动换行</text>
  </view>

  <!-- 文字样式设置 -->
  <view class="style-section">
    <view class="style-section-header" bindtap="toggleTextStyle">
      <text class="style-section-title">文字样式设置</text>
      <text class="style-section-arrow">{{textStyleExpanded ? '▼' : '▶'}}</text>
    </view>
    <view class="style-section-content" wx:if="{{textStyleExpanded}}">
      <view class="style-row">
        <text class="style-label">文字位置：</text>
        <picker mode="selector" range="{{positionOptions}}" range-key="label" value="{{textPositionIndex}}" bindchange="onPositionChange">
          <view class="style-picker">{{positionOptions[textPositionIndex].label}}</view>
        </picker>
      </view>
      <view class="style-row">
        <text class="style-label">字体大小：</text>
        <slider 
          value="{{fontSize}}" 
          min="20" 
          max="100" 
          step="5"
          show-value
          bindchange="onFontSizeChange"
          activeColor="#667eea"
        />
      </view>
      <view class="style-row">
        <text class="style-label">文字颜色：</text>
        <view class="color-picker-wrapper">
          <view class="color-preview" style="background: rgb({{textColorRgb}})" bindtap="showColorPicker" data-type="text"></view>
          <input 
            class="color-input" 
            type="text" 
            value="{{textColorRgb}}" 
            placeholder="255,255,255"
            bindinput="onTextColorInput"
            maxlength="11"
          />
        </view>
      </view>
      <view class="style-row">
        <text class="style-label">描边颜色：</text>
        <view class="color-picker-wrapper">
          <view class="color-preview" style="background: rgb({{strokeColorRgb}})" bindtap="showColorPicker" data-type="stroke"></view>
          <input 
            class="color-input" 
            type="text" 
            value="{{strokeColorRgb}}" 
            placeholder="0,0,0"
            bindinput="onStrokeColorInput"
            maxlength="11"
          />
        </view>
      </view>
      <view class="style-row">
        <text class="style-label">描边宽度：</text>
        <slider 
          value="{{strokeWidth}}" 
          min="1" 
          max="10" 
          step="1"
          show-value
          bindchange="onStrokeWidthChange"
          activeColor="#667eea"
        />
      </view>
    </view>
  </view>

  <!-- 滤镜选择 -->
  <view class="style-section">
    <view class="style-section-header" bindtap="toggleFilter">
      <text class="style-section-title">滤镜效果</text>
      <text class="style-section-arrow">{{filterExpanded ? '▼' : '▶'}}</text>
    </view>
    <view class="style-section-content" wx:if="{{filterExpanded}}">
      <view class="filter-buttons">
        <view 
          wx:for="{{filters}}" 
          wx:key="code"
          class="filter-btn {{selectedFilter === item.code ? 'active' : ''}}"
          bindtap="selectFilter"
          data-filter="{{item.code}}"
        >
          <text class="filter-text">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 生成按钮 -->
  <button 
    class="generate-btn {{canGenerate ? '' : 'disabled'}}" 
    bindtap="generateMeme"
    disabled="{{!canGenerate || loading}}"
  >
    {{loading ? '生成中...' : '生成情绪表情'}}
  </button>

  <!-- 加载提示 -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <text class="loading-text">AI 正在生成情绪表情图片...</text>
  </view>

  <!-- 错误提示 -->
  <view wx:if="{{error}}" class="error">{{error}}</view>

  <!-- 结果展示 -->
  <view wx:if="{{resultImageUrl}}" class="result-area">
    <text class="result-title">✨ {{resultEmotion}}表情生成完成！</text>
    <image src="{{resultImageUrl}}" class="result-image" mode="aspectFit" bindtap="previewImage"></image>
    <button class="action-btn" bindtap="saveImage">保存到相册</button>
    <button class="action-btn secondary" bindtap="reset">重新生成</button>
  </view>
</view>

