# 表情包生成 MVP 项目设计文档

## 一、项目简介

本项目是一个基于 Spring Boot 的图片表情包自动生成服务。用户上传一张图片，系统通过 AI 多模态模型理解图片内容，自动生成适合的中文文案，并将文案绘制到图片上生成表情包。

**核心价值**：零门槛、自动化、快速生成个性化表情包

## 二、MVP 功能说明

### 2.1 核心功能
1. **图片上传**：接收用户上传的图片文件
2. **AI 图片理解**：调用多模态大模型分析图片内容
3. **文案生成**：基于图片内容自动生成一句表情包文案
4. **图片合成**：将文案绘制到图片上（底部居中，白字黑描边）
5. **结果返回**：返回生成的表情包图片 URL

### 2.2 功能边界
- ✅ 支持常见图片格式（JPG、PNG）
- ✅ 自动文案生成
- ✅ 文字自动换行
- ❌ 不支持用户系统
- ❌ 不支持数据库存储
- ❌ 不支持复杂前端界面
- ❌ 不支持用户鉴权

## 三、系统架构说明

### 3.1 整体架构
```
用户请求
  ↓
MemeController (REST API 层)
  ↓
MemeService (业务逻辑层)
  ├──→ AiService (AI 服务层)
  │     └──→ AiClient (AI 客户端，封装 OpenAI 接口)
  └──→ ImageComposeService (图片合成服务层)
  ↓
返回生成的表情包 URL
```

### 3.2 技术组件
- **Web 层**：Spring Boot Web（处理文件上传）
- **AI 层**：封装 OpenAI 风格的多模态 API（GPT-4 Vision 或类似）
- **图片处理层**：Java Graphics2D（文字绘制）
- **存储层**：本地文件系统（临时存储生成的表情包）

### 3.3 数据流
1. 用户上传图片 → MultipartFile
2. 图片转 Base64 → 发送给 AI 模型
3. AI 返回理解结果和文案 → ImageUnderstandResult
4. 使用 Graphics2D 在图片上绘制文案
5. 保存合成后的图片到本地
6. 返回图片访问 URL

## 四、核心流程

### 4.1 完整流程图
```
[用户上传图片]
    ↓
[接收 MultipartFile]
    ↓
[图片转 Base64]
    ↓
[调用 AI 模型理解图片]
    ↓
[AI 返回：描述 + 文案]
    ↓
[读取原图片为 BufferedImage]
    ↓
[创建 Graphics2D 画布]
    ↓
[在图片底部绘制文案]
    - 字体：黑体
    - 颜色：白色
    - 描边：黑色
    - 位置：底部居中
    - 自动换行
    ↓
[保存合成后的图片]
    ↓
[返回图片 URL]
```

### 4.2 关键步骤说明

**步骤 1：图片上传接收**
- 使用 `@RequestParam("image") MultipartFile` 接收
- 验证文件格式和大小

**步骤 2：AI 调用**
- 将图片转换为 Base64 编码
- 调用 AiClient 的 `understandImage` 方法
- 传入图片 Base64 和提示词（要求生成表情包文案）

**步骤 3：图片合成**
- 使用 `ImageIO.read()` 读取原图
- 创建 `Graphics2D` 对象
- 设置字体、颜色、描边样式
- 计算文字位置（底部居中）
- 处理文字换行（按宽度自动换行）
- 绘制文字和描边

**步骤 4：保存和返回**
- 使用 `ImageIO.write()` 保存图片
- 生成访问 URL（如：`/output/meme_xxx.jpg`）
- 返回给用户

## 五、API 设计说明

### 5.1 生成表情包接口

**接口路径**：`POST /api/meme/generate`

**请求参数**：
- `image` (MultipartFile, required)：上传的图片文件

**响应格式**：
```json
{
  "success": true,
  "message": "表情包生成成功",
  "imageUrl": "/output/meme_1234567890.jpg"
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "错误信息",
  "imageUrl": null
}
```

### 5.2 图片访问
- 生成的表情包存储在 `src/main/resources/static/output/`
- 通过静态资源访问：`http://localhost:8080/output/meme_xxx.jpg`

## 六、后续可扩展方向

### 6.1 功能扩展
1. **多文案风格**：支持不同风格的表情包文案（搞笑、吐槽、卖萌等）
2. **文字样式自定义**：支持字体大小、颜色、位置自定义
3. **批量处理**：支持一次上传多张图片批量生成
4. **模板系统**：预设多种表情包模板（上下文字、全屏文字等）
5. **历史记录**：添加数据库存储用户生成历史

### 6.2 技术优化
1. **异步处理**：大图片处理改为异步任务
2. **图片压缩**：自动压缩大尺寸图片
3. **缓存机制**：相同图片缓存结果
4. **云存储**：集成 OSS 存储生成的表情包
5. **AI 模型切换**：支持切换不同的 AI 模型（GPT-4V、Claude、通义千问等）

### 6.3 用户体验
1. **前端界面**：开发简单的前端上传页面
2. **实时预览**：支持实时预览生成效果
3. **下载功能**：支持直接下载生成的表情包
4. **分享功能**：生成分享链接

### 6.4 系统增强
1. **用户系统**：添加用户注册登录
2. **权限管理**：API 调用频率限制
3. **监控告警**：添加系统监控和异常告警
4. **日志系统**：完善日志记录和查询

